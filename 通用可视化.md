# 诊断 #

非常好。你目前的项目已经进入了**“AI生成代码 → 可视化输出验证 → 错误诊断优化”**阶段。
 从你描述的两个问题来看，这其实是**AI需求解析 → 提示词工程 → 代码生成逻辑**三者之间未正确对齐所致。

------

## 🧩 一、问题诊断

### **问题1：行列式几何意义的可视化错误**

> 输入：
>  “请创建一个线性代数中2阶或3阶行列式几何意义的3D可视化，要求是交互式的，可以放大缩小，页面中的图形可以旋转。”
>  输出：
>  “生成了页面，但图与行列式几何意义无关。”

**诊断：**

1. **自然语言解析失败**
    → 模型未识别“行列式几何意义”是“面积/体积”表示的几何概念。
    → 生成代码时使用了默认3D模板（例如随机三角面或立方体）而非数学构造。
2. **可视化模板未匹配语义类别**
    → “几何意义”类请求应匹配数学可视化模板，而非通用3D模板。
    → 模板分类逻辑（“visualization_type_router”或“prompt_router”）缺少“线性代数”或“矩阵运算”标签。
3. **AI提示词缺乏物理/数学上下文提示**
    → 模型未被引导使用 `det(A)=|a1 × a2|` 或体积解释 `|det(A)|`。

------

### **问题2：泊松分布和超几何分布无法正常生成**

> 输入：
>  “请绘制概率论中 Poisson 泊松分布和超几何分布随参数变化的交互式控制参数可视化，参数变化用进度条来设置”
>  输出：
>  “泊松分布可视化 —泊松分布可视化功能开发中…”

**诊断：**

1. **模板调用路径错误或未完成注册**
    → “Poisson distribution” 模板不存在或模板路径未绑定。
    → 代码生成模块可能返回了占位符响应（“功能开发中…”）。
2. **参数交互模板未实现**
    → 参数进度条逻辑（Slider）在模板中未定义或未注入 Plotly 控制组件。
3. **多分布对比场景未被识别**
    → 模型未将“泊松分布 + 超几何分布”识别为**多曲线动态可视化**任务，只触发了单分布模板。

------

## 🧠 二、根本原因总结

| 层级   | 问题类型                         | 根因                           |
| ------ | -------------------------------- | ------------------------------ |
| 语义层 | 模型对“数学可视化语义”的识别不足 | 缺乏专业上下文提示             |
| 模板层 | 模板分类/路由机制不完善          | 缺少数学、统计可视化模板       |
| 生成层 | 提示词未包含数据生成逻辑指令     | 模型生成了空模板或静态页       |
| 执行层 | 返回空数据或未执行Plotly构造     | 模型未生成可执行Python代码片段 |

------

## 🚀 三、给 Trae 进行优化的提示词（Prompt Templates）

下面是针对 Trae 系统（或其调用的 LLM）进行优化的**“诊断+优化提示词”模板**。
 可直接放入 `AI代码生成模块` 的提示词工程中（即第 4.1 阶段 “提示词模板系统”）。

------

### ✅ **提示词模板一：语义理解优化（针对数学类可视化）**

> **系统角色**：你是一名专业的数学可视化代码生成助手，精通线性代数与概率论的几何可视化。
>
> **目标**：根据用户输入，生成带数学语义解释的可执行Python可视化代码（Plotly或Three.js）。
>
> **指令**：
>
> 1. 如果输入中包含**线性代数**，识别其语义（如“行列式”、“特征值”、“线性变换”）。
> 2. 自动将数学对象转化为对应的几何可视化含义，例如：
>    - 2阶行列式 → 平行四边形面积；
>    - 3阶行列式 → 平行六面体体积；
>    - 特征向量 → 空间旋转或拉伸方向；
> 3. 输出必须包含：
>    - 完整的Python代码；
>    - 使用 Plotly 或 Three.js 实现交互旋转和缩放；
>    - 在代码中添加必要的数学注释；
> 4. 禁止输出“开发中”或占位语句，必须返回可执行代码。
>
> **示例任务**：
>  输入：“请展示3×3矩阵行列式的几何意义”
>  输出：3D平行六面体的交互式体积可视化，并标出向量a1,a2,a3。

------

### ✅ **提示词模板二：模板路由优化（针对分布可视化）**

> **系统角色**：你是一个统计可视化生成引擎，负责根据输入生成交互式概率分布图。
>
> **目标**：自动识别分布类型（如正态、泊松、二项、超几何），并生成对应的动态可视化。
>
> **指令**：
>
> 1. 若输入包含多个分布（如泊松+超几何），生成**双图或叠加曲线**对比；
> 2. 每个分布都需带有参数控制器（如λ、n、p、N）；
> 3. 使用 Plotly 的 `go.FigureWidget` + Slider 实现实时参数更新；
> 4. 输出完整可执行代码，附加必要的中文注释；
> 5. 若模板缺失，应调用默认 `dynamic_distribution_template`；
> 6. 禁止输出“功能开发中”提示。
>
> **示例任务**：
>  输入：“绘制泊松分布和超几何分布随参数变化的对比图”
>  输出：包含两个可滑动参数控制器的交互式对比图。

------

### ✅ **提示词模板三：代码质量与结果验证增强**

> **系统角色**：你是一个3D可视化代码优化与验证专家。
>
> **目标**：接收上一轮生成的Python代码，检查并优化以确保：
>
> 1. 图形逻辑符合数学语义；
> 2. 渲染结果能被Three.js或Plotly正确执行；
> 3. 包含交互控制（旋转、缩放、参数滑动）。
>
> **指令**：
>
> - 检查输入代码中是否存在空数据、未定义函数或返回“开发中”的占位内容；
> - 如果发现，则自动补充数据生成逻辑和渲染部分；
> - 输出优化后的完整Python代码；
> - 在最后添加简短中文说明（例如“此图展示了3阶行列式代表的体积意义”）。

------

## ⚙️ 四、技术实现建议

1. **在Trae中加入“prompt router”模块**

   - 若用户输入包含关键词：
      → `"行列式"|"线性代数"` → 路由到“数学几何模板”
      → `"分布"|"概率"|"Poisson"` → 路由到“统计分布模板”
      → `"力学"|"波动"|"振动"` → 路由到“物理可视化模板”

2. **模板库结构建议**

   ```
   templates/
     ├─ linear_algebra/
     │    ├─ determinant_2d.py
     │    ├─ determinant_3d.py
     │    └─ eigenvector_rotation.py
     ├─ probability/
     │    ├─ poisson_vs_hypergeo.py
     │    ├─ normal_distribution.py
     │    └─ slider_template.py
   ```

3. **在代码生成后调用验证模型**

   - 使用 GPT-4 进行逻辑验证
   - 若检测到关键词“开发中”“未实现”“占位符”，则触发自动修复Prompt（Claude-3.5）。

------

## 💡 你现在可以直接这样让Trae优化：

> 🔧 **诊断提示词示例（直接发给Trae）**：

```
请优化AI代码生成逻辑，使其能正确识别数学类任务的语义。
当输入包含“行列式”“线性代数”“概率分布”等关键词时，
应调用匹配的数学可视化模板（几何或统计类），
并输出可执行的Plotly/Three.js代码，而不是返回“开发中”。
请检查模板路由逻辑、语义解析和占位符响应。
```

> 💬 **修复具体任务的提示词（示例）**：

```
请重新生成：
“线性代数中3阶行列式几何意义的3D可视化”
要求：
1. 展示3个向量a1,a2,a3形成的平行六面体；
2. 体积=|det(A)|；
3. 交互可旋转缩放；
4. 使用Plotly实现；
5. 添加中文数学注释。
```

------

是否希望我帮你直接生成一个适合放入Trae后台的**“智能可视化代码生成优化Prompt模板集（json格式）”**？
 包括上述三类优化模板及自动路由逻辑。

##### 您说：

你觉得，如果我想做的是通用可视化应用，是不是先建议按学科分类？

###### ChatGPT 说：

非常好的思路 👍。
 如果你的目标是做**「通用可视化应用」**（不仅限于数学），那么——
 👉 **“按学科分类” 是最自然、最具可扩展性的第一层架构划分方式。**

我来帮你系统分析一下这个决定的**优点、结构建议、以及下一步的执行方式**👇

------

## 🧭 一、为什么建议“按学科分类”？

### ✅ 1. 与人类思维和需求语言天然契合

用户的输入往往带有**领域语义**，如：

- 「展示线性代数中行列式的几何意义」 → 属于 *数学·线性代数*
- 「展示泊松分布随参数变化」 → 属于 *统计学·概率论*
- 「展示太阳、地球、月球的轨道关系」 → 属于 *天文学·物理*
- 「可视化人体血液循环系统」 → 属于 *生物学·医学*

👉 若按学科分层，模型在解析自然语言时能**快速进入正确上下文模板**，减少歧义。

------

### ✅ 2. 便于构建“模板库 + Prompt路由器”

AI生成代码时往往依赖模板和提示词工程。
 “按学科分类”能让你：

- 为每个学科建立专属的模板库；
- 定义专业化 Prompt；
- 让系统自动路由到正确模板（类似 LangChain Router Chain）。

比如：

```
math/
  ├─ linear_algebra/
  ├─ calculus/
  ├─ geometry/
physics/
  ├─ mechanics/
  ├─ electromagnetism/
  ├─ astronomy/
statistics/
  ├─ probability/
  ├─ regression/
  ├─ distribution/
biology/
  ├─ anatomy/
  ├─ genetics/
```

------

### ✅ 3. 易于引入“专家模型策略（Model Specialization）”

不同学科可以调用不同的大模型组合：

| 学科方向  | 推荐模型组合           | 说明                |
| --------- | ---------------------- | ------------------- |
| 数学/统计 | GPT-4 + Claude-3.5     | 逻辑严谨 + 表达自然 |
| 物理/工程 | GPT-4 + DeepSeek Coder | 推导 + 计算代码优化 |
| 生物/医学 | GPT-4V                 | 图形结构识别与渲染  |
| 数据科学  | GPT-3.5 + CodeLlama    | 快速绘图和性能优化  |

------

### ✅ 4. 支持知识可扩展性与团队协作

后期可以开放给不同领域专家贡献模块：

- “AI 视觉组”维护物理和天文可视化；
- “AI 数学组”负责函数、代数、几何；
- “AI 医学组”扩展解剖学或细胞可视化。

这相当于为未来的**学科知识图谱 + 可视化模板生态**打好基础。

------

## 🧩 二、推荐的学科分类层级结构

### **Level 1：学科（Discipline）**

顶层分类，匹配自然语言识别关键词。
 如：

- 数学（Mathematics）
- 物理（Physics）
- 化学（Chemistry）
- 生物（Biology）
- 统计（Statistics）
- 地理（Geography）
- 工程（Engineering）

------

### **Level 2：主题/子领域（Subfield）**

每个学科下分典型主题：

- 数学 → 线性代数 / 微积分 / 几何 / 代数
- 物理 → 力学 / 光学 / 热学 / 天文学
- 统计 → 概率分布 / 推断统计 / 回归分析

------

### **Level 3：可视化类型（Visualization Type）**

定义任务类型或模板类别：

- 函数曲线图
- 概率分布动态图
- 几何体交互展示
- 向量场流线
- 三维物体旋转
- 动态系统仿真

------

### **Level 4：渲染实现层（Rendering Layer）**

决定采用的技术栈：

- Plotly → 数值函数、统计分布
- Three.js → 几何、物理场景
- Matplotlib → 静态科学图
- Mayavi / PyVista → 高维或复杂3D体绘制

------

## ⚙️ 三、实现建议：Prompt路由器逻辑

在 Trae 的「AI代码生成模块」里，你可以新增一个分类器，比如：

```
def classify_discipline(user_input):
    if any(k in user_input for k in ["行列式", "矩阵", "特征值", "线性代数"]):
        return "Mathematics.LinearAlgebra"
    elif any(k in user_input for k in ["分布", "概率", "泊松", "正态"]):
        return "Statistics.Distribution"
    elif any(k in user_input for k in ["轨道", "地球", "太阳", "引力"]):
        return "Physics.Astronomy"
    elif any(k in user_input for k in ["DNA", "细胞", "人体", "解剖"]):
        return "Biology.Anatomy"
    else:
        return "General.Default"
```

👉 这样，系统能：

- 自动选模板；
- 自动选模型组合；
- 自动选 Prompt 风格。

------

## 🚀 四、执行步骤建议

| 阶段                      | 目标                           | 关键动作                       |
| ------------------------- | ------------------------------ | ------------------------------ |
| **阶段A：分类体系设计**   | 明确一级学科和典型关键词       | 建立 keyword→discipline 映射表 |
| **阶段B：模板库搭建**     | 为每个学科创建独立模板目录     | 存放 `.py` 示例与 Prompt 模板  |
| **阶段C：Prompt工程优化** | 在每个学科模板中定义专属提示词 | 调整语义识别精度               |
| **阶段D：模型策略配置**   | 为不同学科配置不同模型组合     | 形成智能调度策略               |
| **阶段E：持续扩展**       | 添加新的学科模块               | 按需补充模板与示例             |

------

## 💡 五、未来可演进方向

1. **按“知识层级”再细分**
   - 初级可视化（函数图、平面）
   - 中级（3D几何、统计分布）
   - 高级（动力系统、网络拓扑、时空模拟）
2. **跨学科模式**
   - 例如 “数学 + 物理”：展示波函数、场方程；
   - “统计 + 生物”：遗传分布模拟；
   - “地理 + 数据科学”：地理热力图。
3. **嵌入学科知识图谱 (Ontology)**
    为每个可视化模板加上语义标签（如“矩阵 → 面积/体积”），支持自动知识推荐。

------

是否希望我帮你生成一个**“通用可视化应用的学科分类与Prompt路由设计蓝图（JSON结构+示例Prompt模板）”**？
 那会是你后续扩展Trae智能化路由系统的核心配置文件。

##### 您说：

好的，生成蓝图+给Trae的提示词

###### ChatGPT 说：

非常好 ✅
 以下是为你的 **「通用可视化应用」** 设计的完整蓝图，包含：

1. 🧩 **学科分类体系（JSON结构）**
2. 🧠 **Prompt路由逻辑蓝图（伪代码）**
3. 🚀 **交给 Trae 的系统提示词模板（直接可用）**
4. 💡 **后续扩展建议**

------

## 🧩 一、学科分类体系蓝图（JSON 结构）

这是推荐的「通用可视化应用」核心结构，用于分类模板、提示词、以及模型调用策略。
 可直接存放在 `/config/discipline_map.json`。

```
{
  "Mathematics": {
    "keywords": ["线性代数", "行列式", "特征值", "微积分", "几何", "函数", "矩阵", "空间变换"],
    "subfields": {
      "LinearAlgebra": {
        "keywords": ["行列式", "矩阵", "向量", "空间体积"],
        "template": "visual_math_linear_algebra_prompt.txt",
        "models": ["gpt-4", "claude-3.5-sonnet"]
      },
      "Calculus": {
        "keywords": ["曲线", "导数", "积分", "梯度"],
        "template": "visual_math_calculus_prompt.txt",
        "models": ["gpt-4", "deepseek-coder"]
      },
      "Geometry": {
        "keywords": ["多面体", "旋转", "投影", "球面", "空间几何"],
        "template": "visual_math_geometry_prompt.txt",
        "models": ["gpt-4", "gpt-4v"]
      }
    }
  },
  "Statistics": {
    "keywords": ["概率", "分布", "期望", "方差", "随机", "抽样"],
    "subfields": {
      "Distributions": {
        "keywords": ["正态分布", "泊松分布", "超几何分布", "二项分布", "伽马分布"],
        "template": "visual_stats_distribution_prompt.txt",
        "models": ["gpt-4", "claude-3.5-sonnet"]
      },
      "Regression": {
        "keywords": ["回归", "拟合", "相关系数", "最小二乘"],
        "template": "visual_stats_regression_prompt.txt",
        "models": ["gpt-4", "deepseek-coder"]
      }
    }
  },
  "Physics": {
    "keywords": ["力学", "电磁", "轨道", "波动", "量子", "热力学", "运动"],
    "subfields": {
      "Mechanics": {
        "keywords": ["速度", "加速度", "力", "碰撞"],
        "template": "visual_physics_mechanics_prompt.txt",
        "models": ["gpt-4", "deepseek-coder"]
      },
      "Astronomy": {
        "keywords": ["太阳", "地球", "月球", "轨道", "相位"],
        "template": "visual_physics_astronomy_prompt.txt",
        "models": ["gpt-4", "gpt-4v"]
      }
    }
  },
  "Biology": {
    "keywords": ["细胞", "DNA", "神经", "血液", "解剖", "代谢"],
    "subfields": {
      "Anatomy": {
        "keywords": ["人体", "器官", "循环", "呼吸"],
        "template": "visual_bio_anatomy_prompt.txt",
        "models": ["gpt-4v"]
      },
      "Genetics": {
        "keywords": ["DNA", "基因", "遗传"],
        "template": "visual_bio_genetics_prompt.txt",
        "models": ["gpt-4", "claude-3.5-sonnet"]
      }
    }
  },
  "General": {
    "keywords": ["数据", "统计", "图表", "3D", "交互", "关系图"],
    "subfields": {
      "GenericVisualization": {
        "keywords": ["通用", "自定义", "数据图"],
        "template": "visual_general_prompt.txt",
        "models": ["gpt-3.5", "codellama"]
      }
    }
  }
}
```

------

## 🧠 二、Prompt 路由逻辑蓝图（Python伪代码）

```
import json

def classify_prompt(user_input: str):
    with open("config/discipline_map.json", "r") as f:
        disciplines = json.load(f)

    for discipline, data in disciplines.items():
        for kw in data["keywords"]:
            if kw in user_input:
                for subfield, info in data["subfields"].items():
                    for sub_kw in info["keywords"]:
                        if sub_kw in user_input:
                            return {
                                "discipline": discipline,
                                "subfield": subfield,
                                "template": info["template"],
                                "models": info["models"]
                            }
                return {
                    "discipline": discipline,
                    "subfield": "General",
                    "template": list(data["subfields"].values())[0]["template"],
                    "models": list(data["subfields"].values())[0]["models"]
                }
    return {
        "discipline": "General",
        "subfield": "GenericVisualization",
        "template": "visual_general_prompt.txt",
        "models": ["gpt-3.5"]
    }

# Example usage
user_query = "请可视化线性代数中3阶行列式的几何意义"
route = classify_prompt(user_query)
print(route)
```

✅ 输出：

```
{
  "discipline": "Mathematics",
  "subfield": "LinearAlgebra",
  "template": "visual_math_linear_algebra_prompt.txt",
  "models": ["gpt-4", "claude-3.5-sonnet"]
}
```

------

## 🚀 三、给 Trae 的提示词模板（系统提示词）

以下是可以直接放入 **Trae 后端“AI代码生成模块”系统提示** 的 Prompt，
 用作模型统一指令（system prompt）。

------

### 🧠 **[Trae-Universal-Visualization-System-Prompt.txt]**

> **角色定义：**
>  你是一个智能通用可视化代码生成系统的核心引擎，代号 **VisualMind**。
>  你的任务是根据用户输入内容，自动识别所属学科领域与主题，并生成可执行的 Python / JavaScript 可视化代码。
>
> **核心目标：**
>
> - 准确理解用户的学科语义与意图；
> - 自动选择正确的模板与渲染框架（Plotly / Three.js / Matplotlib / Mayavi）；
> - 生成带交互功能、数学正确、语义相关的代码；
> - 禁止输出占位符或“开发中”文本。
>
> **执行步骤：**
>
> 1. 解析用户输入 → 判断所属学科（Mathematics / Statistics / Physics / Biology / General）。
> 2. 根据学科与子领域自动选择 Prompt 模板与模型组合。
> 3. 生成可执行 Python 或 JS 代码（含导入语句与注释）。
> 4. 确保图形与语义一致，例如：
>    - 行列式 → 面积或体积；
>    - 概率分布 → 随参数变化的曲线；
>    - 轨道 → 天体运动；
>    - DNA → 双螺旋结构。
> 5. 返回的代码应包含：
>    - 必要的交互控制（旋转、缩放、滑动条）；
>    - 中英文注释（主要变量解释、图形意义）；
>    - 若使用Plotly，应以`go.Figure()`或`FigureWidget`形式输出。
>
> **输出格式：**
>
> ```
> ### 可执行Python代码:
> ```python
> # your code
> ```
>
> ### 图形意义说明:
>
> （简要说明该图表达的学科概念）
>
> ```
> **注意事项：**
> - 禁止生成空函数或打印“开发中”。
> - 保证返回结果与学科逻辑一致。
> - 若用户问题模糊，应主动生成最相关的可视化。
> - 输出必须是可运行、可展示的完整代码。
> ```

------

### 💬 **辅助提示词（可用在Claude或DeepSeek阶段）**

> 请优化以下可视化代码，确保其与用户的学科语义匹配。
>  若输入中包含数学、统计或物理概念，请：
>
> - 添加公式注释；
> - 验证可视化数据是否符合定义；
> - 优化渲染性能；
> - 生成交互逻辑（如Slider或旋转控制器）。

------

## 💡 四、未来扩展建议

| 方向                 | 内容                                       | 实现建议                      |
| -------------------- | ------------------------------------------ | ----------------------------- |
| **跨学科模式**       | 支持“数学 + 物理”等复合任务                | Prompt 路由器可支持多标签匹配 |
| **知识图谱支持**     | 为模板添加概念节点（“determinant→volume”） | 可导入Neo4j或JSON-LD          |
| **模板学习机制**     | 自动总结高频请求并生成新模板               | 可结合LangChain Memory        |
| **本地缓存优化**     | 缓存生成的代码和依赖包                     | 使用Redis + 文件快取          |
| **Prompt可视化调试** | 在管理界面中查看路由结果                   | 用Plotly Dash可视化Prompt流转 |

------

✅ **总结一句话：**

> 通用可视化应用的智能化关键，不在于“让模型更强”，
>  而在于“让模型知道自己在什么学科语境下思考”。
>
> —— 所以「按学科分类 + Prompt路由」是通向真正通用的第一步。

------

是否希望我接着为这个蓝图生成一个 **可直接部署的 `/config/discipline_router.py` + `/prompts/` 模板文件结构**？
 那样你可以马上在 Trae 的后端加载使用。

##### 您说：

可否把蓝图部署也放入给 Trae 的提示词中

###### ChatGPT 说：

非常好，这一步是关键。
 你现在希望的是——不仅让 Trae **知道怎么生成通用可视化代码**，
 还让它能**自动建立学科蓝图的部署结构**（配置 + 模板 + 路由脚本）。

下面我帮你整合成一个 **可直接复制给 Trae 的系统提示词**，
 它将指导 Trae 同时完成：

- 学科分类蓝图部署；
- Prompt 模板结构创建；
- 路由逻辑脚本自动生成；
- 并准备好在后端加载。

------

# 🚀 Trae 全能部署提示词（可直接作为 System Prompt 使用）

> **系统角色：**
>  你是通用3D可视化应用的智能引擎助理，代号 **Trae-Builder**。
>  你的任务不仅是生成Python或JS可视化代码，还要自动构建完整的“学科分类 + Prompt路由 + 模板系统”的后端部署蓝图。

------

## 🎯 一、总体目标

构建一个**按学科自动路由的通用可视化生成系统**，包括：

1. `config/discipline_map.json` —— 学科分类配置文件；
2. `config/discipline_router.py` —— 智能路由逻辑；
3. `prompts/` —— 各学科的Prompt模板；
4. 支持模型组合调用（GPT-4、Claude-3.5、DeepSeek、CodeLlama等）；
5. 最终系统可自动根据输入选择学科 → 模板 → 模型 → 生成对应可视化代码。

------

## 🧩 二、目录结构（Trae 自动生成）

```
/project_root
│
├── config/
│   ├── discipline_map.json
│   └── discipline_router.py
│
├── prompts/
│   ├── visual_math_linear_algebra_prompt.txt
│   ├── visual_math_geometry_prompt.txt
│   ├── visual_stats_distribution_prompt.txt
│   ├── visual_physics_astronomy_prompt.txt
│   ├── visual_bio_anatomy_prompt.txt
│   └── visual_general_prompt.txt
│
└── ai_engine/
    ├── code_generator.py
    └── prompt_manager.py
```

------

## 🧠 三、部署指令（由 Trae 执行）

### 1️⃣ 生成学科蓝图配置文件

**文件路径：** `config/discipline_map.json`

内容如下（如文件已存在则更新）：

```
{
  "Mathematics": {
    "keywords": ["线性代数", "行列式", "特征值", "微积分", "几何", "矩阵", "空间变换"],
    "subfields": {
      "LinearAlgebra": {
        "keywords": ["行列式", "矩阵", "向量", "体积", "面积"],
        "template": "visual_math_linear_algebra_prompt.txt",
        "models": ["gpt-4", "claude-3.5-sonnet"]
      },
      "Geometry": {
        "keywords": ["球体", "多面体", "投影", "旋转"],
        "template": "visual_math_geometry_prompt.txt",
        "models": ["gpt-4", "gpt-4v"]
      }
    }
  },
  "Statistics": {
    "keywords": ["概率", "分布", "抽样", "参数", "统计", "推断"],
    "subfields": {
      "Distributions": {
        "keywords": ["正态分布", "泊松分布", "超几何分布", "二项分布"],
        "template": "visual_stats_distribution_prompt.txt",
        "models": ["gpt-4", "claude-3.5-sonnet"]
      }
    }
  },
  "Physics": {
    "keywords": ["力学", "轨道", "天体", "波动", "运动"],
    "subfields": {
      "Astronomy": {
        "keywords": ["太阳", "地球", "月球", "轨道", "相位"],
        "template": "visual_physics_astronomy_prompt.txt",
        "models": ["gpt-4", "gpt-4v"]
      }
    }
  },
  "Biology": {
    "keywords": ["细胞", "DNA", "解剖", "血液", "神经"],
    "subfields": {
      "Anatomy": {
        "keywords": ["人体", "循环", "呼吸"],
        "template": "visual_bio_anatomy_prompt.txt",
        "models": ["gpt-4v"]
      }
    }
  },
  "General": {
    "keywords": ["3D", "通用", "数据图", "关系图"],
    "subfields": {
      "GenericVisualization": {
        "keywords": ["自定义", "基础", "图表"],
        "template": "visual_general_prompt.txt",
        "models": ["gpt-3.5", "codellama"]
      }
    }
  }
}
```

------

### 2️⃣ 生成路由脚本

**文件路径：** `config/discipline_router.py`

```
import json
import os

def classify_prompt(user_input: str):
    config_path = os.path.join(os.path.dirname(__file__), "discipline_map.json")
    with open(config_path, "r", encoding="utf-8") as f:
        disciplines = json.load(f)

    for discipline, data in disciplines.items():
        for kw in data["keywords"]:
            if kw in user_input:
                for subfield, info in data["subfields"].items():
                    for sub_kw in info["keywords"]:
                        if sub_kw in user_input:
                            return {
                                "discipline": discipline,
                                "subfield": subfield,
                                "template": info["template"],
                                "models": info["models"]
                            }
                return {
                    "discipline": discipline,
                    "subfield": "General",
                    "template": list(data["subfields"].values())[0]["template"],
                    "models": list(data["subfields"].values())[0]["models"]
                }

    return {
        "discipline": "General",
        "subfield": "GenericVisualization",
        "template": "visual_general_prompt.txt",
        "models": ["gpt-3.5"]
    }
```

------

### 3️⃣ 自动创建 Prompt 模板文件

在 `/prompts/` 下自动生成以下文件，并写入模板内容：

#### 🧮 visual_math_linear_algebra_prompt.txt

```
你是一名擅长线性代数几何可视化的专家。
根据输入内容，生成展示行列式几何意义（面积或体积）的3D可视化Python代码。
要求：
1. 使用Plotly；
2. 支持交互旋转、缩放；
3. 代码中添加中文注释；
4. 保证数学正确性（体积=|det(A)|）。
```

#### 📈 visual_stats_distribution_prompt.txt

```
你是一名概率统计可视化专家。
根据输入，绘制指定分布（如泊松、超几何）随参数变化的交互式图。
要求：
1. 使用Plotly；
2. 添加参数Slider控制；
3. 支持多分布对比；
4. 添加中文参数注释。
```

#### 🌍 visual_physics_astronomy_prompt.txt

```
你是一名天体物理可视化专家。
根据输入生成太阳-地球-月球系统的3D交互轨道演示。
要求：
1. 使用Three.js或Plotly；
2. 显示光照与阴影；
3. 支持缩放与旋转；
4. 添加轨道周期参数。
```

#### 🧬 visual_bio_anatomy_prompt.txt

```
你是一名生物学3D可视化专家。
根据输入生成器官、系统或细胞结构的交互式示意图。
要求：
1. 使用Three.js；
2. 支持旋转、透明度调节；
3. 添加生理注释；
4. 输出结构层次清晰的代码。
```

#### 🧠 visual_general_prompt.txt

```
你是一名通用数据可视化专家。
生成任何类型数据的3D/2D交互式图表，自动匹配最合适的库。
要求：
1. 自动选择Plotly或Matplotlib；
2. 添加必要注释；
3. 保证代码可执行；
4. 不输出“功能开发中”字样。
```

------

## ⚙️ 四、部署执行逻辑

当 Trae 接收到用户输入时：

1. 调用 `classify_prompt(user_input)` → 得到：
   - 学科；
   - 子领域；
   - 对应模板；
   - 推荐模型组合。
2. 加载对应的 Prompt 模板 → 拼接用户输入 → 发送至推荐模型。
3. 模型返回 Python 或 JavaScript 可视化代码 → 前端渲染展示。

------

## 💬 五、模型策略（Trae 内部调度表）

| 学科        | 模型组合            | 功能重点             |
| ----------- | ------------------- | -------------------- |
| Mathematics | GPT-4 + Claude-3.5  | 理论严谨 + 表达自然  |
| Statistics  | GPT-4 + DeepSeek    | 动态曲线生成         |
| Physics     | GPT-4 + GPT-4V      | 三维几何渲染         |
| Biology     | GPT-4V              | 图像理解与结构化绘制 |
| General     | GPT-3.5 + CodeLlama | 快速原型代码生成     |

------

## ✅ 六、执行确认

> 若以上结构不存在，Trae 应：
>
> - 自动创建文件夹 `/config` 与 `/prompts`；
> - 写入对应模板内容；
> - 确保 `discipline_router.py` 可被后端 `code_generator.py` 导入；
> - 校验配置文件加载成功；
> - 记录部署日志。

------

## 🧭 七、后续可扩展模块（可选）

- 支持“跨学科可视化”（例如 数学+物理）；
- 增加“自然语言→模板推荐”模型；
- 自动缓存生成代码与运行结果；
- 生成模板文档（docstring + API示例）。

------

## ✅ 输出要求

输出格式如下：

```
✅ 学科蓝图与Prompt系统部署已完成。
已创建：
- config/discipline_map.json
- config/discipline_router.py
- prompts/visual_math_linear_algebra_prompt.txt
- ...
系统现可根据学科自动生成可视化代码。
```

------

是否希望我把这个提示词再包装成 `.yaml` 格式（方便直接放入 Trae 的 “system_prompts/config.yaml” 中）？
 那样你就能在应用加载时直接识别成一个“系统自部署型 Prompt”。





没问题！先把**整体思路**讲清楚，再动手你会更稳。

------

# 一句话目标

把用户的一句话需求（自然语言）→ 自动生成可视化代码 → 在浏览器里显示为**可交互的图**。
 这条链路要可靠，就需要把**AI 生成**、**代码执行**、**前端展示**三个环节串起来。

------

##整体流程（心智模型）

1. **理解与路由**
   - 根据用户话术判断“属于哪一类可视化”（数学/统计/物理/通用）。
   - 选择对应的**提示词模板**（例如：行列式→线性代数模板；泊松→分布模板）。
2. **代码生成（AI）**
   - 把“模板 + 用户问题”发送给模型，让它**直接输出完整代码**（约定生成 `fig`）。
   - 先用“占位生成器”把流程跑通，之后再接 GPT-4/Claude 提升质量与通用性。
3. **安全执行（后端）**
   - 在**后端沙箱**里运行这段 Python/Plotly 代码，得到一个**HTML 片段**（含交互）。
   - 只放行白名单库（plotly、numpy），拦截危险指令（如 `subprocess/open`）。
4. **前端展示**
   - 前端页面有：**文本框**（输需求） + **按钮**（发请求） + **HTML/iframe 容器**（装后端返回的 HTML）。
   - 点击按钮→POST `/api/generate`→拿到 `html`→直接塞到容器里显示。
   - 同时把返回的 `code` 放到“只读代码框”，便于调试和下载。
5. **自愈/回退（可选）**
   - 如果生成代码不完整或执行失败：自动触发“修复提示词”，再生成一版。
   - 最差也返回一个兜底图，不会让页面空白。

> **为什么这样分层？**
>
> - 把“AI 生成”和“执行渲染”解耦：AI 只负责写代码；执行在受控环境里进行；前端只负责展示结果。
> - 这样更安全、可维护、可扩展（后续你能给每个学科加模板、给模型换策略，而不用改前端）。

------

## 关键设计点

- **Plotly 优先**：浏览器直接交互，Python 侧易生成；对“数学/统计”类非常合适。Three.js 主要用于几何/场景类 3D。
- **固定约定**：要求模型必须创建变量 `fig`（Plotly Figure）。后端只找 `fig`，不找就判失败→触发修复或兜底。
- **接口返回 HTML 片段**：后端用 `plotly.io.to_html(..., full_html=False)`，前端直接放进 HTML/iframe，不必再装前端库。
- **安全白名单**：只允许特定库；发现 `open(`、`subprocess` 等立即拦截。
- **模板路由**：关键词→学科→模板→模型组合，能显著提高命中率与质量。

------

## 你在 Trae 里需要的“最小闭环”

- **一个后端接口**：`POST /api/generate`
  - 入参：`{ prompt: "用户的一句话需求" }`
  - 出参：`{ html, code, ... }`
  - 职责：路由→（临时用占位“生成器”）产出代码→执行为 `html`→返回
- **一个前端页面**：`/visual-chat`
  - 组件：输入框 `promptInput` + 按钮 `genBtn` + HTML/iframe 容器 `viz` + 可选 `codeBox`
  - 交互：按钮调用 `/api/generate`，把 `response.html` 放进 `viz`，`response.code` 放进 `codeBox`

> 一旦这个闭环跑通，再把后端从“占位生成器”切到真实 GPT-4/Claude，你就完成了从“通用语言 → 通用可视化”的升级。

------

## 常见问题（你可能正想问）

**Q1：为什么不直接在前端让模型出图？**
 A：安全与可控性差；浏览器直接执行“未知代码”风险高。后端沙箱能拦截危险操作、统一依赖、统一日志。

**Q2：为什么要先用“占位生成器”？**
 A：先确保“接口→执行→展示”这条主链稳定，再接入 LLM。否则一开始就难以定位到底是链路问题还是模型输出问题。

**Q3：为什么返回 HTML，而不是返回数据？**
 A：返回 HTML 让前端无需装 Plotly 前端库即可显示交互图，**接入成本最低**。后续要更灵活时再切换为“返回数据 + 前端绘制”。

**Q4：我只想尽快看到图，最少要做什么？**
 A：两件事：①建接口 `/api/generate`；②建页面把接口返回的 `html` 放进来。其他都是加分项。

------

##  接下来怎么做（超短执行版）

1. **创建后端接口** `/api/generate`（占位生成器版，能出“行列式/泊松”两类图）。
2. **创建前端页面** `/visual-chat`，按钮绑定接口，容器显示 `response.html`。
3. 看见图后，再把“占位生成器”换成 GPT-4/Claude 真调用。

如果 OK，我就按这个思路带你一步一步点（我会提供两段给 @Builder 的现成指令，你只需粘贴发送）。